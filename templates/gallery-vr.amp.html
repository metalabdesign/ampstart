<!doctype html>

<!---
Copyright 2017 The AMP Start Authors. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS-IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

{{#gallery-vr}}
<html>
  {{#head-tag}}
  <head>
    <meta charset="utf-8">
    <title>{{title}}</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    {{#font-stylesheets}}
    <link href="{{{.}}}" rel="stylesheet">
    {{/font-stylesheets}}

    <link href="dist/css/{{{css-path}}}" rel="stylesheet" amp-custom>
  </head>
  {{/head-tag}}
  <body>
    <div id="scene" class="scene">
    </div>
<script type="text/javascript">
(function() {
  'use strict';

  var Util = (function() {
    function handleAMPMessage(type, handler) {
      return function(event) {
        if (
          event.source === window.parent &&
          event.origin === window.location.origin &&
          event.data &&
          event.data.sentinel === 'amp' &&
          event.data.type === type
        ) {
          handler(event.data);
        }
      };
    }

    return {
      handleAMPMessage: handleAMPMessage
    }
  })();

  var Matrix = (function(){
    var DEG_TO_RAD = Math.PI / 180;

    function matrix3FromOrientation(z, x, y) {
      var zRad = z * DEG_TO_RAD;
      var xRad = x * DEG_TO_RAD;
      var yRad = y * DEG_TO_RAD;

      var cosZ = Math.cos(zRad);
      var sinZ = Math.sin(zRad);

      var cosX = Math.cos(xRad);
      var sinX = Math.sin(xRad);

      var cosY = Math.cos(yRad);
      var sinY = Math.sin(yRad);

      return [
        cosZ * cosY - sinZ * sinX * sinY,
        -cosX * sinZ,
        cosZ * sinY + cosY * sinZ * sinX,

        cosY * sinZ + cosZ * sinX * sinY,
        cosZ * cosX,
        sinZ * sinY - cosZ * cosY * sinX,

        -cosX * sinY,
        sinX,
        cosX * cosY
      ];
    };

    function multiplyMatrix3(a, b) {
      if (a.length !== 9 || b.length !== 9) {
        throw new TypeError('Expected Matrix3');
      }

      return [
        a[0] * b[0] + a[1] * b[3] + a[2] * b[6],
        a[0] * b[1] + a[1] * b[4] + a[2] * b[7],
        a[0] * b[2] + a[1] * b[5] + a[2] * b[8],

        a[3] * b[0] + a[4] * b[3] + a[5] * b[6],
        a[3] * b[1] + a[4] * b[4] + a[5] * b[7],
        a[3] * b[2] + a[4] * b[5] + a[5] * b[8],

        a[6] * b[0] + a[7] * b[3] + a[8] * b[6],
        a[6] * b[1] + a[7] * b[4] + a[8] * b[7],
        a[6] * b[2] + a[7] * b[5] + a[8] * b[8],
      ];
    }

    function matrix4FromMatrix3(m) {
      if (m.length !== 9) {
        throw new TypeError('Expected Matrix3');
      }

      return [
        m[0], m[1], m[2], 0,
        m[3], m[4], m[5], 0,
        m[6], m[7], m[8], 0,
        0, 0, 0, 1,
      ];
    }

    function transformFromMatrix4(m) {
      if (m.length !== 16) {
        throw new TypeError('Expected Matrix4');
      }

      return 'matrix3d(' + m.join(', ') + ')';
    }

    return {
      matrix3FromOrientation: matrix3FromOrientation,
      multiplyMatrix3: multiplyMatrix3,
      matrix4FromMatrix3: matrix4FromMatrix3,
      transformFromMatrix4: transformFromMatrix4,
    };
  })();


  // Initialize scene layout.
  (function() {
    var GOLDEN_ANGLE = Math.PI * (3 - Math.sqrt(5));

    var sceneElement = document.getElementById('scene');

    var count = 30;
    var tileSize = 40;
    var tiles = new Array(count);

    var selectedTile;
    function createTile() {
      var width = Math.round(Math.random() * 200 + 200);
      var height = Math.round(Math.random() * 200 + 200);

      var tileElement = document.createElement('div');
      var imgElement = document.createElement('img');
      var buttonElement = document.createElement('div');

      tileElement.className = 'tile';

      imgElement.style.width = tileElement.style.width =
        (tileSize * (300 / width)) + 'vmin';

      imgElement.style.height = tileElement.style.height =
        (tileSize * (300 / height)) + 'vmin';

      imgElement.src = 'https://unsplash.it/' + height + '/' + width + '/?random';

      buttonElement.className = 'button';

      if (width > height) {
        buttonElement.style.left = (Math.round(Math.random()) * 100) + '%';
        buttonElement.style.top = (Math.round(Math.random()) * 60 + 20) + '%';
      } else {
        buttonElement.style.top = (Math.round(Math.random()) * 100) + '%';
        buttonElement.style.left = (Math.round(Math.random()) * 60 + 20) + '%';
      }

      tileElement.appendChild(imgElement);
      tileElement.appendChild(buttonElement);
      sceneElement.appendChild(tileElement);

      tileElement.addEventListener('click', function() {
        if (selectedTile) {
          selectedTile.className = 'tile';
        }

        tileElement.className = 'tile selected';
        selectedTile = tileElement;
        positionTiles();
      });

      return tileElement;
    }

    // http://blog.marmakoide.org/?p=1
    // https://codepen.io/nealgranger/pen/NgbMZX
    for (var i = 0; i < count; i++) {
      var t = i / (count - 1);
      var v = i * GOLDEN_ANGLE;

      var r = 0.75 + t - t * t + Math.random() * 0.2;

      var x = Math.cos(v) * r;
      var y = Math.sin(v) * r;
      var z = t - 0.5;

      var pitch = v + Math.PI / 2 + Math.random() - 0.5;
      var yaw = -Math.sin(z) - Math.PI / 2 + Math.random() - 0.5;

      tiles[i] = {
        element: createTile(),
        pitch,
        yaw,
        x,
        y,
        z,
      };
    }

    var worldTransform = 'translateZ(' + 50 + 'vmin) rotateX(90deg)';
    var indicator = document.createElement('div');
    indicator.className = 'indicator';
    document.body.appendChild(indicator);

    function positionTiles() {
      for (var i = 0, len = tiles.length; i < len; i ++) {
        var tile = tiles[i];

        tile.element.style.zIndex = len - i;

        tile.element.style.transform =
          worldTransform + ' ' +
          'translate3d(' + tile.x * 100 + 'vmin, ' + tile.y * 100 + 'vmin, ' + tile.z * 150 + 'vmin) ' +
          'rotateZ(' + tile.pitch + 'rad) rotateX(' + tile.yaw + 'rad)' ;

        if (selectedTile) {
          var rect = selectedTile.getBoundingClientRect();
          indicator.style.top = rect.top + 'px';
          indicator.style.left = rect.left + 'px';
          indicator.style.width = rect.width + 'px';
          indicator.style.height = rect.height + 'px';
        }
      }
    }

    positionTiles();

    // Listen for orientation change events and update scene.
    var orientationUpdate;

    var handleOrientation = Util.handleAMPMessage('orientation', function(message) {
      window.cancelAnimationFrame(orientationUpdate);
      orientationUpdate = window.requestAnimationFrame(function() {
        var rotation = Matrix.multiplyMatrix3(
          Matrix.matrix3FromOrientation(-message.alpha, -message.beta, message.gamma),
          Matrix.matrix3FromOrientation(message.orientation, 0, 0)
        );

        worldTransform = 'translateZ(' + 50 + 'vmin) ' +
          Matrix.transformFromMatrix4(Matrix.matrix4FromMatrix3(rotation));
        positionTiles();
      });
    });

    window.addEventListener('message', handleOrientation);
  })();
})();
</script>
  </body>
</html>
{{/gallery-vr}}
