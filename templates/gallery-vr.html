<!doctype html>

<!---
Copyright 2017 The AMP Start Authors. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS-IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

{{#gallery-vr}}
<html>
  {{#head-tag}}
  <head>
    <meta charset="utf-8">
    <title>{{title}}</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    {{#font-stylesheets}}
    <link href="{{{.}}}" rel="stylesheet">
    {{/font-stylesheets}}

    <link href="dist/css/{{{css-path}}}" rel="stylesheet" amp-custom>
  </head>
  {{/head-tag}}
  <body>
    <div id="scene">
      <svg id="debug" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" style="position: absolute; z-index: 1; pointer-events: none">


      </svg>
    </div>
<script type="text/json" id="data">
[
  {
    "width": 268,
    "height": 327,
    "image": "../img/gallery/327x268.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 323,
    "height": 313,
    "image": "../img/gallery/313x323.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 326,
    "height": 389,
    "image": "../img/gallery/389x326.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 285,
    "height": 229,
    "image": "../img/gallery/229x285.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 247,
    "height": 360,
    "image": "../img/gallery/360x247.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 270,
    "height": 352,
    "image": "../img/gallery/352x270.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 379,
    "height": 234,
    "image": "../img/gallery/234x379.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 397,
    "height": 379,
    "image": "../img/gallery/379x397.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 265,
    "height": 255,
    "image": "../img/gallery/255x265.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 354,
    "height": 232,
    "image": "../img/gallery/232x354.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 367,
    "height": 342,
    "image": "../img/gallery/342x367.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 243,
    "height": 252,
    "image": "../img/gallery/252x243.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 232,
    "height": 341,
    "image": "../img/gallery/341x232.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 332,
    "height": 283,
    "image": "../img/gallery/283x332.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 255,
    "height": 282,
    "image": "../img/gallery/282x255.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 245,
    "height": 381,
    "image": "../img/gallery/381x245.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 234,
    "height": 341,
    "image": "../img/gallery/341x234.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 263,
    "height": 326,
    "image": "../img/gallery/326x263.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 265,
    "height": 386,
    "image": "../img/gallery/386x265.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 364,
    "height": 216,
    "image": "../img/gallery/216x364.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 211,
    "height": 327,
    "image": "../img/gallery/327x211.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 283,
    "height": 330,
    "image": "../img/gallery/330x283.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 224,
    "height": 263,
    "image": "../img/gallery/263x224.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 362,
    "height": 210,
    "image": "../img/gallery/210x362.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 298,
    "height": 240,
    "image": "../img/gallery/240x298.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 277,
    "height": 215,
    "image": "../img/gallery/215x277.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 256,
    "height": 343,
    "image": "../img/gallery/343x256.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 255,
    "height": 330,
    "image": "../img/gallery/330x255.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 241,
    "height": 280,
    "image": "../img/gallery/280x241.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  },
  {
    "width": 331,
    "height": 375,
    "image": "../img/gallery/375x331.jpeg",
    "name": "Exhibit",
    "artist": "Artist",
    "url": "gallery-inner.amp.html"
  }
]
</script>
<script type="text/javascript">
(function() {
  'use strict';

  var Matrix = (function(){
    var DEG_TO_RAD = Math.PI / 180;

    function matrix3FromOrientation(z, x, y) {
      var zRad = z * DEG_TO_RAD;
      var xRad = x * DEG_TO_RAD;
      var yRad = y * DEG_TO_RAD;

      var cosZ = Math.cos(zRad);
      var sinZ = Math.sin(zRad);

      var cosX = Math.cos(xRad);
      var sinX = Math.sin(xRad);

      var cosY = Math.cos(yRad);
      var sinY = Math.sin(yRad);

      return [
        cosZ * cosY - sinZ * sinX * sinY,
        -cosX * sinZ,
        cosZ * sinY + cosY * sinZ * sinX,

        cosY * sinZ + cosZ * sinX * sinY,
        cosZ * cosX,
        sinZ * sinY - cosZ * cosY * sinX,

        -cosX * sinY,
        sinX,
        cosX * cosY
      ];
    };

    function multiplyMatrix3(a, b) {
      if (a.length !== 9 || b.length !== 9) {
        throw new TypeError('Expected Matrix3');
      }
      return [
        a[0] * b[0] + a[1] * b[3] + a[2] * b[6],
        a[0] * b[1] + a[1] * b[4] + a[2] * b[7],
        a[0] * b[2] + a[1] * b[5] + a[2] * b[8],
        a[3] * b[0] + a[4] * b[3] + a[5] * b[6],
        a[3] * b[1] + a[4] * b[4] + a[5] * b[7],
        a[3] * b[2] + a[4] * b[5] + a[5] * b[8],
        a[6] * b[0] + a[7] * b[3] + a[8] * b[6],
        a[6] * b[1] + a[7] * b[4] + a[8] * b[7],
        a[6] * b[2] + a[7] * b[5] + a[8] * b[8],
      ];
    };

    function matrix4FromMatrix3(m) {
      if (m.length !== 9) {
        throw new TypeError('Expected Matrix3');
      }

      return [
        m[0], m[1], m[2], 0,
        m[3], m[4], m[5], 0,
        m[6], m[7], m[8], 0,
        0, 0, 0, 1,
      ];
    }

    function transformFromMatrix4(m) {
      if (m.length !== 16) {
        throw new TypeError('Expected Matrix4');
      }

      var vals = m.map(function (val) {
        return val.toFixed(8).replace(/\.?0+$/, '');
      });

      return 'matrix3d(' + vals.join(', ') + ')';
    }

    return {
      matrix3FromOrientation: matrix3FromOrientation,
      multiplyMatrix3: multiplyMatrix3,
      matrix4FromMatrix3: matrix4FromMatrix3,
      transformFromMatrix4: transformFromMatrix4,
    };
  })();

  var Util = (function() {
    function getUnitVector(from, to) {
      var x = to.x - from.x;
      var y = to.y - from.y;

      var scale = 1 / Math.sqrt(x * x + y * y);

      return {x: x * scale, y: y * scale};
    };

    return {
      getUnitVector: getUnitVector,
    }
  })();

  var Scene = (function(){
    function Scene(options) {
      if (!this instanceof Scene) return new Scene(options);

      this._updateRequest = null;
      this._imagesLoaded = 0;
      this._selectedIndex = null;

      this._onLoad = options.onLoad;

      this._tiles = options.tiles;
      this._target = options.target;

      this._width = options.width;
      this._height = options.height;

      // Perspective depth in vmin units.
      this._perspective = options.perspective || 100;
      // Tile size in vmin uints.
      this._tileSize = options.tileSize || 400;
      // Amount of tile orientation randomness in rad.
      this._orientationVariance = options.orientationVariance || 0;
      // Amount of tile distance randomness, as a ratio of cylinder radius.
      this._cylinderRadiusVariance = options.cylinderRadiusVariance || 0;
      // Tile distance in vmin units;
      this._cylinderRadius = options.cylinderRadius || 100;
      // Scene height (highest tile center to lowest tile center) in vmin units.
      this._cylinderHeight = options.cylinderHeight || 100;
      this._forwardPosition = options.forwardPosition || 0;

      // Preclaculate the layout positions if all of the tiles within the scene.
      this._transforms = this._getTileTransforms();

      this._dragThresholdSquared =
        (options.dragThreshold || 0) * (options.dragThreshold || 0);

      // Set the initial orientation to that of an upright device facing
      // forward. This prevents the scene from starting facing the ground, this
      // is important for clients that do not support orientation detection.
      this._deviceState = {
        orientation: 0,
        alpha: 0,
        beta: 90,
        gamma: 0,
      };

      this._dragState = {
        down: false,
        threshold: false,
        initialClientX: 0,
        initialClientY: 0,
        initialAlpha: 0,
        initialBeta: 0,
        alpha: 0,
        beta: 0,
      };

      this._wheelState = {
        alpha: 0,
        beta: 0,
      };

      // Bind event handlers.
      this._handleClick = this._handleClick.bind(this);
      this._handleImgLoad = this._handleImgLoad.bind(this);
      this._handleMouseDownCapture = this._handleMouseDownCapture.bind(this);
      this._handleMouseMoveCapture = this._handleMouseMoveCapture.bind(this);
      this._handleMouseUpCapture = this._handleMouseUpCapture.bind(this);
      this._handleClickCapture = this._handleClickCapture.bind(this);
      this._handleDragStartCapture = this._handleDragStartCapture.bind(this);
      this._handleWheel = this._handleWheel.bind(this);
      this._applyUpdate = this._applyUpdate.bind(this);

      if (options.enableDrag) {
        this._attachDragEvents();
      }

      if (options.enableWheel) {
        this._attachWheelEvents();
      }

      this._initializeDOM();
      this._queueUpdate();
    }

    Object.defineProperty(Scene.prototype, 'loaded', {
      get: function() {
        return this._imagesLoaded >= this._tiles.length;
      },
    });

    Scene.prototype._handleImgLoad = function(event) {
      this._imagesLoaded++;

      event.target.style.opacity = 1;

      if (this.loaded) {
        // this._sceneElement.style.opacity = 1;
        if (this._onLoad) {
          this._onLoad();
        }
      }
    };

    Scene.prototype._handleDragStartCapture = function(event) {
      event.preventDefault();
    }

    Scene.prototype._handleMouseDownCapture = function(event) {
      if (event.button !== 0) {
        return;
      }

      this._dragState.down = true;
      this._dragState.dragging = false;
      this._dragState.initialClientX = event.clientX;
      this._dragState.initialClientY = event.clientY;
      this._dragState.initialAlpha = this._dragState.alpha;
      this._dragState.initialBeta = this._dragState.beta;
    };

    Scene.prototype._handleMouseMoveCapture = function(event) {
      var dragX, dragY, distanceSquared, min, alpha, beta;

      if (!this._dragState.down) {
        return;
      }

      dragX = event.clientX - this._dragState.initialClientX;
      dragY = event.clientY - this._dragState.initialClientY;

      if (!this._dragState.dragging) {
        if (this._dragThresholdSquared === 0) {
          this._dragState.dragging = true;
        } else {
          distanceSquared = dragX * dragX + dragY * dragY;

          this._dragState.dragging =
            distanceSquared > this._dragThresholdSquared;
        }
      }

      if (!this._dragState.dragging) {
        return;
      }

      event.preventDefault();

      min = Math.min(this._width, this._height);

      alpha = dragX / min * 45;
      beta = dragY / min * 45;

      this._dragState.alpha = this._dragState.initialAlpha + alpha;

      this._dragState.beta = this._dragState.initialBeta + beta;

      this._queueUpdate();
    };

    Scene.prototype._handleMouseUpCapture = function(event) {
      if (this._dragState.down) {
        this._dragState.down = false;

        if (this._dragState.dragging) {
          // Delay toggling the dragging state for a single tick. This is to
          // allow prevent click events from firing at the end of a drag event
          // sequence since the `click` event fires after the  `mouseup` event
          // and cannot be cancelled by the `mouseup` event directly.
          window.setTimeout((function() {
            this._dragState.dragging = false;
          }).bind(this), 0);
        }
      }
    };

    Scene.prototype._handleClickCapture = function(event) {
      if (this._dragState.dragging) {
        event.preventDefault();
        event.stopPropagation();
      }
    };

    Scene.prototype._attachDragEvents = function() {
      this._target.addEventListener('dragstart', this._handleDragStartCapture, true);
      this._target.addEventListener('mousedown', this._handleMouseDownCapture, true);
      window.addEventListener('mousemove', this._handleMouseMoveCapture, true);
      window.addEventListener('mouseup', this._handleMouseUpCapture, true);
      window.addEventListener('click', this._handleClickCapture, true);
    };

    Scene.prototype._handleWheel = function(event) {
      var min, alpha, beta;

      event.preventDefault();

      min = Math.min(this._width, this._height);

      alpha = -event.deltaX / min * 45;
      beta = -event.deltaY / min * 45;

      this._wheelState.alpha = this._wheelState.alpha + alpha;
      this._wheelState.beta = this._wheelState.beta + beta;

      this._queueUpdate();
    };

    Scene.prototype._attachWheelEvents = function() {
      this._target.addEventListener('wheel', this._handleWheel);
    };

    Scene.prototype._getTileTransforms = function() {
      var i, len, t, v, r, x, y, z, pitch, yaw;
      var GOLDEN_ANGLE = Math.PI * (3 - Math.sqrt(5));

      var result = new Array(this._tiles.length);

      for (i = 0, len = this._tiles.length; i < len; i++) {
        t = i / (len - 1);
        v = i * GOLDEN_ANGLE;

        r = 0.75 + t - t * t +
          (Math.random() - 0.5) * this._cylinderRadiusVariance;

        x = Math.cos(v) * r;
        y = Math.sin(v) * r;
        z = t - 0.5;

        pitch = v + Math.PI / 2 +
          (Math.random() - 0.5) * this._orientationVariance;
        yaw = -Math.sin(z) - Math.PI / 2 +
          (Math.random() - 0.5) * this._orientationVariance;

        result[i] = {
          pitch: pitch,
          yaw: yaw,
          x: x,
          y: y,
          z: z,
        };
      }

      return result;
    };

    Scene.prototype._handleClick = function(event) {
      var index;

      if (this._dragState.dragging) {
        return;
      }

      index = JSON.parse(event.currentTarget.getAttribute('data-index'));

      if (typeof index === 'number') {
        this._selectedIndex = index;
        this._queueUpdate();
      }
    };

    Scene.prototype._initializeDOM = function() {
      var tileElement, topRight, bottomRight, bottomLeft, topLeft, img, i, len;

      this._sceneElement = window.document.createElement('div');
      this._sceneElement.style.pointerEvents = 'none';
      this._sceneElement.style.overflow = 'hidden';
      this._sceneElement.style.backfaceVisibility = 'hidden';

      this._tileElements = new Array(this._tiles.length);
      this._imgElements = new Array(this._tiles.length);
      this._tileCornerElements = new Array(this._tiles.length);

      for (i = 0, len = this._tiles.length; i < len; i++) {
        tileElement = window.document.createElement('a');
        tileElement.style.display === 'block';
        tileElement.style.position = 'absolute';
        tileElement.style.top = 0;
        tileElement.style.left = 0;
        tileElement.style.bottom = 0;
        tileElement.style.right = 0;
        tileElement.style.margin = 'auto';
        tileElement.style.pointerEvents = 'all';
        tileElement.style.cursor = 'pointer';

        tileElement.setAttribute('data-index', i);
        tileElement.addEventListener('click', this._handleClick);

        tileElement.setAttribute('href', this._tiles[i].url);
        tileElement.setAttribute('target', '_top');

        topRight = window.document.createElement('div');
        topRight.style.position = 'absolute';
        topRight.style.top = 0;
        topRight.style.right = 0;

        tileElement.appendChild(topRight);

        bottomRight = window.document.createElement('div');
        bottomRight.style.position = 'absolute';
        bottomRight.style.bottom = 0;
        bottomRight.style.right = 0;

        tileElement.appendChild(bottomRight);

        bottomLeft = window.document.createElement('div');
        bottomLeft.style.position = 'absolute';
        bottomLeft.style.bottom = 0;
        bottomLeft.style.left = 0;

        tileElement.appendChild(bottomLeft);

        topLeft = window.document.createElement('div');
        topLeft.style.position = 'absolute';
        topLeft.style.top = 0;
        topLeft.style.left = 0;

        tileElement.appendChild(topLeft);

        img = window.document.createElement('img');
        img.src = this._tiles[i].image;
        img.style.display = 'block';
        img.style.position = 'absolute';
        img.style.top = 0;
        img.style.left = 0;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.opacity = 0;
        img.style.transition = 'opacity 1s';

        img.addEventListener('load', this._handleImgLoad);
        img.addEventListener('error', this._handleImgLoad);

        tileElement.appendChild(img);

        this._sceneElement.appendChild(tileElement);

        this._tileElements[i] = tileElement;
        this._imgElements[i] = img;

        // Store corner elements in clockwise order from top right as expected
        // by surface normal calculation code.
        this._tileCornerElements[i] = [topRight, bottomRight, bottomLeft, topLeft];
      }

      this._target.appendChild(this._sceneElement);

      this._selectionDebug = window.document.createElement('svg');
      this._target.appendChild(this._selectionDebug);
    };

    Scene.prototype._getAlpha = function() {
      return this._deviceState.alpha +
        this._dragState.alpha +
        this._wheelState.alpha;
    };


    Scene.prototype._getBeta = function() {
      return this._deviceState.beta +
        this._dragState.beta +
        this._wheelState.beta;
    };

    Scene.prototype._getGamma = function() {
      return this._deviceState.gamma;
    };

    Scene.prototype._queueUpdate = function() {
      if (this._updateRequest) {
        window.cancelAnimationFrame(this._updateRequest);
      }
      window.requestAnimationFrame(this._applyUpdate);
    };

    Scene.prototype._applyUpdate = function() {
      this._updateRequest = null;

      var i, len, sceneOrientation, tileElement, tileTransform, tile, scale,
        viewPosition, tilePosition, tileOrientation;
      var min = Math.min(this._width, this._height) * 0.01;

      this._sceneElement.style.perspective = min * this._perspective + 'px';
      this._sceneElement.style.width = this._width + 'px';
      this._sceneElement.style.height = this._height + 'px';

      sceneOrientation = Matrix.transformFromMatrix4(
        Matrix.matrix4FromMatrix3(
          Matrix.multiplyMatrix3(
            Matrix.matrix3FromOrientation(-this._getAlpha(), -this._getBeta(), this._getGamma()),
            Matrix.matrix3FromOrientation(this._deviceState.orientation, 0, 0)
          )
        )
      );

      window.document.getElementById('debug').innerHTML = '';

      for (i = 0, len = this._tileElements.length; i < len; i ++) {
        tileElement = this._tileElements[i];
        tileTransform = this._transforms[i];
        tile = this._tiles[i];

        scale = 1 / Math.sqrt(tile.width * tile.height);

        tileElement.style.height = min * this._tileSize * tile.width * scale + 'px';
        tileElement.style.width = min * this._tileSize * tile.height * scale + 'px';
        tileElement.style.boxShadow = '0 0 ' + 10 * min + 'px rgba(0, 0, 0, 0.2)';
``
        // Simulate forward camera movement within the scene. Since setting
        // perspective has the effect of moving the camera backwards, moving
        // forwards by the perspective distance will re-orient the camera to the
        // to the center of the scene.
        viewPosition = 'translateZ(' +
          min * (this._perspective + this._forwardPosition) + 'px' +
        ')';

        // Distribute the tiles around the scene perimeter multiplying the
        // calculated unit-lengths with the configured scene dimensions.
        tilePosition = 'translate3d(' +
          min * tileTransform.x * this._cylinderRadius + 'px, ' +
          min * tileTransform.y * this._cylinderRadius + 'px, ' +
          min * tileTransform.z * this._cylinderHeight + 'px' +
        ')';

        // Orient the tiles so the normals are facing the camera.
        tileOrientation =
          'rotateZ(' + tileTransform.pitch + 'rad) ' +
          'rotateX(' + tileTransform.yaw + 'rad)';

        // The order the transforms are applied is important. Camera movement
        // must precede tile movement, and translation must precede rotation.
        // Translation is relative to current element orientation, so rotating
        // before translating would send the tiles in the wrong direction.
        tileElement.style.transform =
          viewPosition + ' ' +
          sceneOrientation + ' ' +
          tilePosition + ' ' +
          tileOrientation;
      }

      if (this._selectedIndex) {
        // this._debugTile(this._selectedIndex);
      }
    };

    Scene.prototype._debugTile = function (index) {
      var i, len, rect, right, bottom, left, top, facing, path,
        topRightNormal, bottomRightNormal, bottomLeftNormal, topLeftNormal;

      var min = Math.min(this._width, this._height);
      var cornerElements = this._tileCornerElements[index];
      var points = new Array(cornerElements.length);

      for (i = 0, len = cornerElements.length; i < len; i++) {
        rect = cornerElements[i].getBoundingClientRect();
        points[i] = {x: rect.left, y: rect.top};
      }

      right = Util.getUnitVector(points[0], points[1]);
      bottom = Util.getUnitVector(points[1], points[2]);
      left = Util.getUnitVector(points[2], points[3]);
      top = Util.getUnitVector(points[3], points[0]);

      topRightNormal = (top.x * right.y) - (top.y * right.x);
      bottomRightNormal = (right.x * bottom.y) - (right.y * bottom.x);
      bottomLeftNormal = (bottom.x * left.y) - (bottom.y * left.x);
      topLeftNormal = (left.x * top.y) - (left.y * top.x);

      facing =
        topRightNormal > 0 &&
        bottomRightNormal > 0 &&
        bottomLeftNormal > 0 &&
        topLeftNormal > 0;

      if (facing) {
        path = 'M' + points
          .concat(points.slice(0, 1))
          .map(function({x, y}) {return x + ' ' + y;})
          .join(' L ');

        window.document.getElementById('debug').innerHTML +=
          '<path fill="rgba(0,255,127,0.5)" d="' + path + '"/>';
      }
    };

    Scene.prototype.setSize = function(width, height) {
      this._width = width;
      this._height = height;
      this._queueUpdate();
    };

    Scene.prototype.setDeviceOrientation = function(orientation, alpha, beta, gamma) {
      if (
        typeof alpha === 'number' &&
        typeof beta === 'number' &&
        typeof gamma === 'number' &&
        typeof orientation === 'number'
      ) {
        this._deviceState.orientation = orientation;
        this._deviceState.alpha = alpha;
        this._deviceState.beta = beta;
        this._deviceState.gamma = gamma;
        this._queueUpdate();
      }
    };

    return Scene;
  })();

  if (window.parent) {
    window.parent.postMessage({
      sentinel: 'amp',
      type: 'send-device-orientation',
    }, '*');
  }

  // Defer initializing the scene by one tick to prevent scene images from
  // blocking window load event and extending amp-iframe loading state time.
  window.addEventListener('load', function () {
    var scene = new Scene({
      target: window.document.getElementById('scene'),
      tiles: JSON.parse(document.getElementById('data').innerHTML),
      tileSize: 45,
      orientationVariance: 1,
      cylinderRadiusVariance: 0.2,
      perspective: 100,
      cylinderRadius: 110,
      cylinderHeight: 120,
      forwardPosition: -50,
      width: window.document.documentElement.clientWidth,
      height: window.document.documentElement.clientHeight,
      enableDrag: true,
      dragThreshold: 4,
      enableWheel: true
    });

    window.addEventListener('message', function(event) {
      if (
        event.source === window.parent &&
        event.origin === window.location.origin &&
        event.data &&
        event.data.sentinel === 'amp' &&
        event.data.type === 'device-orientation'
      ) {
        scene.setDeviceOrientation(
          event.data.orientation,
          event.data.alpha,
          event.data.beta,
          event.data.gamma
        );
      }
    });

    window.addEventListener('resize', function() {
      scene.setSize(
        window.document.documentElement.clientWidth,
        window.document.documentElement.clientHeight
      );
    });
  });
})();
</script>
  </body>
</html>
{{/gallery-vr}}
